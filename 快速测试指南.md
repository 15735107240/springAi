# 快速测试指南

## 前置准备

### 1. 启动 Redis
```bash
# macOS
brew services start redis

# 验证
redis-cli ping  # 应返回 PONG
```

### 2. 配置 API Keys
编辑 `src/main/resources/application.yml`，配置：
- `spring.ai.dashscope.api-key`: 阿里云 DashScope API Key
- `spring.amap.api-key`: 高德地图 API Key

### 3. 启动应用
```bash
mvn spring-boot:run
```

应用启动在 `http://localhost:10010`

## 基础功能测试

### 1. 对话测试
```bash
# 第一轮对话
curl "http://localhost:10010/api/simple/chat?query=你好，我叫张三&conversantId=test001"

# 第二轮对话（测试记忆）
curl "http://localhost:10010/api/simple/chat?query=我叫什么名字？&conversantId=test001"
# 预期：AI应记住"张三"

# 第三轮对话（测试上下文）
curl "http://localhost:10010/api/simple/chat?query=我住在北京，今天天气怎么样？&conversantId=test001"
# 预期：AI应查询北京天气
```

### 2. 工具调用测试

#### 天气查询
```bash
curl "http://localhost:10010/api/simple/chat?query=今天北京天气怎么样&conversantId=test002"
```

#### 路径规划
```bash
curl "http://localhost:10010/api/simple/chat?query=从人民广场到天安门怎么走&conversantId=test002"
```

#### 周边搜索
```bash
curl "http://localhost:10010/api/simple/chat?query=上海人民广场附近有什么餐厅&conversantId=test002"
```

#### 坐标转地址
```bash
curl "http://localhost:10010/api/simple/chat?query=121.47,31.23这是哪里&conversantId=test002"
```

#### 租房查询
```bash
curl "http://localhost:10010/api/simple/chat?query=我要租房，合租，预算3000-4000，地址在徐汇区&conversantId=test002"
```

#### 订单查询
```bash
curl "http://localhost:10010/api/simple/chat?query=查询订单100123456，用户编号200123456&conversantId=test002"
```

#### 知识库检索
```bash
curl "http://localhost:10010/api/simple/chat?query=闫文杰的项目经历有哪些&conversantId=test002"
```

### 3. 多用户隔离测试
```bash
# 用户A
curl "http://localhost:10010/api/simple/chat?query=我喜欢吃苹果&conversantId=userA"

# 用户B
curl "http://localhost:10010/api/simple/chat?query=我喜欢吃香蕉&conversantId=userB"

# 验证用户A的记忆
curl "http://localhost:10010/api/simple/chat?query=我喜欢吃什么水果？&conversantId=userA"
# 预期：回答"苹果"

# 验证用户B的记忆
curl "http://localhost:10010/api/simple/chat?query=我喜欢吃什么水果？&conversantId=userB"
# 预期：回答"香蕉"
```

## 会话历史管理测试

### 1. 查询会话历史
```bash
# 查询最近10条消息
curl "http://localhost:10010/api/history/test001?lastN=10"

# 查询所有消息
curl "http://localhost:10010/api/history/test001"
```

### 2. 分页查询
```bash
# 第一页（最新消息）
curl "http://localhost:10010/api/history/test001/page?page=1&size=10"

# 第二页
curl "http://localhost:10010/api/history/test001/page?page=2&size=10"
```

### 3. 查询会话信息
```bash
curl "http://localhost:10010/api/history/test001/info"
```

### 4. 清除会话
```bash
curl -X DELETE "http://localhost:10010/api/history/test001"
```

### 5. 刷新过期时间
```bash
curl -X POST "http://localhost:10010/api/history/test001/refresh"
```

### 6. 批量检查
```bash
curl -X POST "http://localhost:10010/api/history/batch/check" \
  -H "Content-Type: application/json" \
  -d '["test001", "test002", "userA"]'
```

### 7. 管理员查询所有会话
```bash
curl "http://localhost:10010/api/history/admin/conversations?adminKey=admin"
```

## Redis 验证

### 查看所有会话
```bash
redis-cli KEYS chat:memory:*
```

### 查看会话数据
```bash
redis-cli LLEN chat:memory:test001
redis-cli TTL chat:memory:test001
```

## 持久化测试

### 1. 创建会话
```bash
curl "http://localhost:10010/api/simple/chat?query=测试持久化&conversantId=persist_test"
```

### 2. 停止应用（Ctrl+C）

### 3. 验证数据仍在 Redis
```bash
redis-cli EXISTS chat:memory:persist_test
# 应返回: (integer) 1
```

### 4. 重启应用
```bash
mvn spring-boot:run
```

### 5. 验证记忆恢复
```bash
curl "http://localhost:10010/api/simple/chat?query=我刚才说了什么？&conversantId=persist_test"
# 预期：AI应能回忆起之前的对话
```

## 故障排查

### Redis连接失败
```bash
# 检查Redis是否运行
redis-cli ping

# 查看应用日志中的错误信息
```

### 会话数据丢失
- 检查会话是否过期（默认7天）
- 检查Redis持久化配置
- 查看 `application.yml` 中的 TTL 设置

### 工具调用失败
- 检查API Key是否正确配置
- 查看日志中的错误信息
- 验证网络连接

## 验证清单

- [ ] Redis连接正常
- [ ] 应用启动成功
- [ ] 基础对话功能正常
- [ ] 多轮对话记忆正常
- [ ] 工具调用正常（天气、路径、周边、坐标转换）
- [ ] 知识库检索正常
- [ ] 多用户隔离正常
- [ ] 会话历史查询正常
- [ ] 分页查询正常
- [ ] 会话管理功能正常（清除、刷新）
- [ ] 管理员接口正常
- [ ] 应用重启后数据不丢失

## 清理测试数据

```bash
redis-cli
> KEYS chat:memory:test_*
> DEL chat:memory:test001 chat:memory:test002 chat:memory:userA chat:memory:userB
```

---

如有问题，请查看项目 [README.md](./README.md) 和 [CHANGELOG.md](./CHANGELOG.md)
