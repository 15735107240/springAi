# Redisson会话记忆功能 - 快速测试指南

## 前置准备

### 1. 启动Redis服务器

确保Redis服务器已启动并运行：

```bash
# macOS (使用Homebrew)
brew services start redis

# 或者直接运行
redis-server

# 检查Redis是否运行
redis-cli ping
# 应该返回: PONG
```

### 2. 启动Spring Boot应用

```bash
# 编译项目
mvn clean package

# 运行应用
mvn spring-boot:run

# 或者运行打包后的jar
java -jar target/chat-1.0-SNAPSHOT.jar
```

等待看到类似日志：
```
RedissonChatMemory initialized with keyPrefix: chat:memory:, ttl: 604800 seconds
Tomcat started on port(s): 10010
```

## 测试场景

### 场景1：基础对话测试

#### 1.1 第一轮对话

```bash
curl "http://localhost:10010/api/simple/chat?query=你好，我叫张三&conversantId=test_user_001"
```

预期响应：AI的问候回复

#### 1.2 第二轮对话（测试记忆功能）

```bash
curl "http://localhost:10010/api/simple/chat?query=我叫什么名字？&conversantId=test_user_001"
```

预期响应：AI应该记住你叫"张三"

#### 1.3 第三轮对话（测试上下文）

```bash
curl "http://localhost:10010/api/simple/chat?query=我住在北京，今天天气怎么样？&conversantId=test_user_001"
```

预期响应：AI调用天气工具查询北京天气

#### 1.4 第四轮对话（测试上下文记忆）

```bash
curl "http://localhost:10010/api/simple/chat?query=明天呢？&conversantId=test_user_001"
```

预期响应：AI应该记住你在问北京的天气

### 场景2：会话历史查询

#### 2.1 分页查询（新功能）⭐

```bash
# 查询第一页（每页10条）
curl "http://localhost:10010/api/history/test_user_001/page?page=1&size=10"

# 查询第二页
curl "http://localhost:10010/api/history/test_user_001/page?page=2&size=10"

# 查询第一页（每页20条，page默认为1）
curl "http://localhost:10010/api/history/test_user_001/page?size=20"
```

预期响应：
```json
{
  "conversationId": "test_user_001",
  "page": 1,
  "size": 10,
  "totalMessages": 8,
  "totalPages": 1,
  "hasNext": false,
  "hasPrevious": false,
  "messages": [...]
}
```

#### 2.2 查询会话信息

```bash
curl "http://localhost:10010/api/history/test_user_001/info"
```

预期响应：
```json
{
  "conversationId": "test_user_001",
  "exists": true,
  "messageCount": 8,
  "remainingTtl": 604800,
  "remainingTtlHours": 168.0
}
```

#### 2.3 查询最近3条消息（按时间倒序）

```bash
curl "http://localhost:10010/api/history/test_user_001?lastN=3"
```

> 📌 **注意**：返回的消息按时间倒序，最新的消息在前

#### 2.4 查询所有历史消息（按时间倒序）

```bash
curl "http://localhost:10010/api/history/test_user_001"
```

> 📌 **说明**：所有查询结果都是最新的消息在前，旧消息在后

### 场景3：多用户隔离测试

#### 3.1 用户A的对话

```bash
curl "http://localhost:10010/api/simple/chat?query=我喜欢吃苹果&conversantId=user_A"
```

#### 3.2 用户B的对话

```bash
curl "http://localhost:10010/api/simple/chat?query=我喜欢吃香蕉&conversantId=user_B"
```

#### 3.3 验证用户A的记忆

```bash
curl "http://localhost:10010/api/simple/chat?query=我喜欢吃什么水果？&conversantId=user_A"
```

预期响应：AI应该回答"苹果"

#### 3.4 验证用户B的记忆

```bash
curl "http://localhost:10010/api/simple/chat?query=我喜欢吃什么水果？&conversantId=user_B"
```

预期响应：AI应该回答"香蕉"

### 场景4：管理员功能测试 🔐

#### 4.1 查询所有会话（需要管理员权限）

```bash
# 使用正确的管理员密钥
curl "http://localhost:10010/api/history/admin/conversations?adminKey=admin"
```

预期响应：
```json
{
  "total": 3,
  "conversationIds": ["test_user_001", "user_A", "user_B"],
  "conversations": [
    {
      "conversationId": "test_user_001",
      "messageCount": 8,
      "remainingTtl": 604800
    },
    ...
  ]
}
```

#### 4.2 测试权限验证（错误的密钥）

```bash
# 不提供密钥
curl "http://localhost:10010/api/history/admin/conversations"

# 错误的密钥
curl "http://localhost:10010/api/history/admin/conversations?adminKey=wrong"
```

预期响应：
```json
{
  "error": "无权限访问",
  "message": "需要管理员权限才能访问此接口"
}
```

### 场景5：会话管理

#### 5.1 刷新会话过期时间

```bash
curl -X POST "http://localhost:10010/api/history/test_user_001/refresh"
```

#### 5.2 批量检查会话存在性

```bash
curl -X POST "http://localhost:10010/api/history/batch/check" \
  -H "Content-Type: application/json" \
  -d '["test_user_001", "user_A", "user_B", "not_exists"]'
```

预期响应：
```json
{
  "total": 4,
  "exists": {
    "test_user_001": true,
    "user_A": true,
    "user_B": true,
    "not_exists": false
  }
}
```

#### 5.3 清除会话历史

```bash
curl -X DELETE "http://localhost:10010/api/history/test_user_001"
```

#### 5.4 验证清除结果

```bash
curl "http://localhost:10010/api/history/test_user_001/info"
```

预期响应：
```json
{
  "conversationId": "test_user_001",
  "exists": false,
  "messageCount": 0,
  "remainingTtl": -1,
  "remainingTtlHours": 0.0
}
```

### 场景6：Redis数据验证

#### 6.1 使用管理员接口查看所有会话（推荐）

```bash
# 通过API查看
curl "http://localhost:10010/api/history/admin/conversations?adminKey=admin"
```

#### 6.2 使用Redis命令查看所有会话

```bash
redis-cli
> KEYS chat:memory:*
```

预期输出：
```
1) "chat:memory:test_user_001"
2) "chat:memory:user_A"
3) "chat:memory:user_B"
```

#### 6.3 查看某个会话的数据

```bash
redis-cli
> LRANGE chat:memory:user_A 0 -1
```

#### 6.4 查看会话的过期时间（TTL）

```bash
redis-cli
> TTL chat:memory:user_A
```

预期输出：接近604800秒（7天）

#### 6.5 查看会话的消息数量

```bash
redis-cli
> LLEN chat:memory:user_A
```

### 场景7：持久化测试

#### 7.1 创建会话并发送消息

```bash
curl "http://localhost:10010/api/simple/chat?query=我是测试持久化的用户&conversantId=persistence_test"
```

#### 7.2 停止应用

按 `Ctrl+C` 停止Spring Boot应用

#### 7.3 验证Redis中数据仍存在

```bash
redis-cli
> EXISTS chat:memory:persistence_test
# 应该返回: (integer) 1
```

#### 7.4 重启应用

```bash
mvn spring-boot:run
```

#### 7.5 验证记忆恢复

```bash
curl "http://localhost:10010/api/simple/chat?query=我刚才说了什么？&conversantId=persistence_test"
```

预期响应：AI应该能够回忆起之前的对话

## 性能测试

### 测试1：并发对话测试

使用Apache Bench或类似工具测试并发性能：

```bash
# 安装Apache Bench (macOS)
brew install httpd

# 并发10个请求，共100个请求
ab -n 100 -c 10 "http://localhost:10010/api/simple/chat?query=hello&conversantId=perf_test"
```

### 测试2：大量历史消息测试

```bash
# 创建包含大量消息的会话
for i in {1..50}; do
  curl "http://localhost:10010/api/simple/chat?query=这是第${i}条消息&conversantId=large_history_test"
  sleep 1
done

# 查询性能
time curl "http://localhost:10010/api/history/large_history_test"
```

## 故障模拟

### 模拟1：Redis连接断开

```bash
# 停止Redis
brew services stop redis

# 尝试对话
curl "http://localhost:10010/api/simple/chat?query=测试&conversantId=test"

# 查看应用日志，应该有错误日志但应用不应崩溃

# 重启Redis
brew services start redis
```

### 模拟2：Redis内存不足

```bash
# 设置较小的Redis内存限制
redis-cli CONFIG SET maxmemory 10mb
redis-cli CONFIG SET maxmemory-policy allkeys-lru

# 创建大量会话直到内存满
# 观察旧会话是否被正确淘汰
```

## 验证清单

完成以下检查项：

- [ ] Redis连接正常
- [ ] 应用启动成功，没有错误日志
- [ ] 基础对话功能正常
- [ ] 多轮对话能够记住上下文
- [ ] 不同用户的会话相互隔离
- [ ] 会话历史查询API正常工作
- [ ] 分页查询功能正常（页码从1开始）
- [ ] 会话管理API（清除、刷新）正常工作
- [ ] 管理员接口可以查询所有会话 🆕
- [ ] 管理员接口权限验证正常 🆕
- [ ] Redis中能看到正确的数据结构
- [ ] 应用重启后会话数据不丢失
- [ ] 会话过期时间设置正确
- [ ] 并发访问没有数据混乱
- [ ] Redis连接异常时应用不崩溃

## 预期日志示例

### 成功的日志

```
2025-10-30 10:00:00 [main] INFO  c.s.chat.config.RedissonConfig - Redisson client configured with address: redis://localhost:6379, database: 0
2025-10-30 10:00:00 [main] INFO  c.s.chat.config.RedissonConfig - Creating RedissonChatMemory with keyPrefix: chat:memory:, ttl: 604800 seconds
2025-10-30 10:00:01 [main] INFO  c.s.chat.HelloApplication - Started HelloApplication in 3.456 seconds
2025-10-30 10:01:00 [http-nio-10010-exec-1] INFO  c.s.chat.controller.SpringAiController - Received chat request
2025-10-30 10:01:00 [http-nio-10010-exec-1] DEBUG c.s.chat.memory.RedissonChatMemory - Added 2 messages to conversation: test_user_001
2025-10-30 10:01:00 [http-nio-10010-exec-1] DEBUG c.s.chat.memory.RedissonChatMemory - Retrieved 10 messages (last 100) from conversation: test_user_001
```

### 异常日志（Redis连接失败）

```
2025-10-30 10:05:00 [http-nio-10010-exec-2] ERROR c.s.chat.memory.RedissonChatMemory - Failed to add messages to conversation: test_user_001
org.redisson.client.RedisConnectionException: Unable to connect to Redis server
```

## 调试技巧

### 1. 查看详细日志

在 `application.yml` 中临时开启DEBUG日志：

```yaml
logging:
  level:
    com.springai.chat.memory: DEBUG
    com.springai.chat.service: DEBUG
    org.redisson: DEBUG
```

### 2. 使用Redis Monitor

```bash
redis-cli MONITOR
```

实时查看所有Redis命令

### 3. 查看内存使用

```bash
redis-cli INFO memory
```

### 4. 查看连接数

```bash
redis-cli INFO clients
```

## 常见问题

**Q: 为什么会话历史丢失了？**
A: 检查会话是否过期（默认7天），或者Redis是否重启且未开启持久化。

**Q: 不同用户的对话混在一起了？**
A: 检查conversantId是否正确传递且唯一。

**Q: 性能很慢？**
A: 检查网络延迟、Redis服务器性能、连接池配置是否合理。

**Q: 应用启动时报Redis连接错误？**
A: 确保Redis服务已启动，检查配置文件中的host、port、password是否正确。

## 完成测试后

记得清理测试数据：

```bash
redis-cli
> KEYS chat:memory:test_*
> DEL chat:memory:test_user_001 chat:memory:user_A chat:memory:user_B
> KEYS chat:memory:*
```

或者清空整个测试数据库：

```bash
redis-cli -n 0 FLUSHDB
```

---

测试愉快！如有问题，请参考《Redisson会话记忆使用说明.md》

